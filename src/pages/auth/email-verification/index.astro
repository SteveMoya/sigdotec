---
import { sendEmailVerificationEmail } from "@/lib/email/sendEmail";
import { createVerificationToken } from "@/lib/auth/lucia";

import Layout from "@layouts/Layout.astro";
import VerifyEmail from "@/components/VerifyEmail";

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect("/login", 302);
}
if (user.emailVerificated) {
  return Astro.redirect("/app/", 302);
}

try {
  const token = await createVerificationToken(user.email);
  console.log(token);

  if (Astro.request.method === "POST") {
    try {
      console.log("AQUI DEBERIA DE Comenzar");
      await sendEmailVerificationEmail(user.email, token.toString());
      return Astro.redirect("/auth/email-verification", 302); // Redirige después de enviar el correo
    } catch (error) {
      console.log(error);
      return new Response("Error al enviar tu email de Verificación", {
        status: 400,
      });
    }
  }

  // Renderiza la página de verificación de correo electrónico aquí
} catch (error) {
  console.error(error);
  return new Response("Error interno del servidor", { status: 500 });
}
---

<Layout>
  <div class="flex justify-center content-center my-[6dvh]">
    <!-- <VerifyEmail email={user.email} client:load transition:persist /> -->
  </div>
</Layout>
